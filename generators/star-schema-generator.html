<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power BI Star Schema Dataset Generator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
            color: #1e293b;
        }
        
        .header {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
        }
        
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .schema-diagram {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            text-align: center;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            color: #374151;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }
        
        .card h2 {
            color: #1e40af;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .button {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 10px 10px 0;
            transition: all 0.3s ease;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(30, 64, 175, 0.3);
        }
        
        .button.download-all {
            background: linear-gradient(135deg, #059669, #10b981);
            font-size: 1.1rem;
            padding: 18px 35px;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 5px;
        }
        
        .metric-label {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .dimension-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .dimension-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
        }
        
        .dimension-card h3 {
            color: #1e40af;
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .dimension-card ul {
            margin: 0;
            padding-left: 20px;
            color: #64748b;
        }
        
        .code {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .instructions {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .instructions h3 {
            color: #92400e;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>⭐ Star Schema Dataset Generator</h1>
        <p>Enterprise-grade dimensional model for advanced Power BI analytics</p>
    </div>

    <div class="card">
        <h2>🏗️ Star Schema Design</h2>
        <div class="schema-diagram">
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐<br>
│   DIM_Customer  │    │   DIM_Product   │    │  DIM_Geography  │<br>
│─────────────────│    │─────────────────│    │─────────────────│<br>
│ CustomerID (PK) │    │ ProductID (PK)  │    │ GeographyID(PK) │<br>
│ CustomerName    │    │ ProductName     │    │ Country         │<br>
│ Industry        │    │ Category        │    │ Region          │<br>
│ Size            │    │ SubCategory     │    │ SubRegion       │<br>
│ Tier            │    │ ProductLine     │    │ City            │<br>
└─────────────────┘    └─────────────────┘    └─────────────────┘<br>
         │                       │                       │<br>
         └───────────────┐       │       ┌───────────────┘<br>
                         │       │       │<br>
┌─────────────────┐      ▼       ▼       ▼      ┌─────────────────┐<br>
│ DIM_SalesRep    │  ┌─────────────────────────┐ │    DIM_Date     │<br>
│─────────────────│  │     FACT_Orders         │ │─────────────────│<br>
│ SalesRepID (PK) │  │─────────────────────────│ │ Date (PK)       │<br>
│ RepName         │──│ OrderID (PK)            │─│ Year            │<br>
│ RepTeam         │  │ OrderDate (FK)          │ │ Quarter         │<br>
│ RepRegion       │  │ CustomerID (FK)         │ │ Month           │<br>
│ RepLevel        │  │ ProductID (FK)          │ │ FiscalYear      │<br>
└─────────────────┘  │ GeographyID (FK)        │ │ FiscalQuarter   │<br>
                     │ SalesRepID (FK)         │ │ IsBusinessDay   │<br>
         ┌───────────│ ChannelID (FK)          │ └─────────────────┘<br>
         │           │ Revenue                 │<br>
         ▼           │ Cost                    │<br>
┌─────────────────┐  │ GrossProfit             │<br>
│  DIM_Channel    │  │ Quantity                │<br>
│─────────────────│  │ UnitPrice               │<br>
│ ChannelID (PK)  │  └─────────────────────────┘<br>
│ ChannelName     │<br>
│ ChannelType     │<br>
│ ChannelCost%    │<br>
└─────────────────┘
        </div>
    </div>

    <div class="card">
        <h2>📊 Dataset Specifications</h2>
        <div class="metrics">
            <div class="metric">
                <div class="metric-value" id="factRecords">--</div>
                <div class="metric-label">Fact Records</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="timeRange">5 Years</div>
                <div class="metric-label">Time Range</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="dimensions">6</div>
                <div class="metric-label">Dimensions</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="totalRevenue">--</div>
                <div class="metric-label">Total Revenue</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="customers">500</div>
                <div class="metric-label">Customers</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="products">60</div>
                <div class="metric-label">Products</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>🎯 Dimension Tables</h2>
        <div class="dimension-grid">
            <div class="dimension-card">
                <h3>👥 Customer Dimension</h3>
                <ul>
                    <li>500 unique customers</li>
                    <li>Industry hierarchy</li>
                    <li>Company size tiers</li>
                    <li>Customer segments</li>
                </ul>
            </div>
            <div class="dimension-card">
                <h3>📦 Product Dimension</h3>
                <ul>
                    <li>4 categories, 12 subcategories</li>
                    <li>60 individual products</li>
                    <li>Product lines and families</li>
                    <li>Pricing tiers</li>
                </ul>
            </div>
            <div class="dimension-card">
                <h3>🌍 Geography Dimension</h3>
                <ul>
                    <li>Country → Region → SubRegion</li>
                    <li>Major cities and territories</li>
                    <li>Market classifications</li>
                    <li>Time zones</li>
                </ul>
            </div>
            <div class="dimension-card">
                <h3>👤 Sales Rep Dimension</h3>
                <ul>
                    <li>Sales team hierarchy</li>
                    <li>Rep performance levels</li>
                    <li>Territory assignments</li>
                    <li>Team structures</li>
                </ul>
            </div>
            <div class="dimension-card">
                <h3>🛒 Channel Dimension</h3>
                <ul>
                    <li>Sales channel types</li>
                    <li>Partner tiers</li>
                    <li>Commission structures</li>
                    <li>Cost percentages</li>
                </ul>
            </div>
            <div class="dimension-card">
                <h3>📅 Date Dimension</h3>
                <ul>
                    <li>2020-2024 (5 years)</li>
                    <li>Fiscal calendar support</li>
                    <li>Business day flags</li>
                    <li>Holiday calendar</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>📁 Download Star Schema Files</h2>
        <p>Generate and download all dimension and fact tables for your Power BI star schema:</p>
        
        <div style="text-align: center; margin: 30px 0;">
            <button class="button download-all" onclick="downloadAllTables()">
                📦 Download Complete Star Schema (7 Files)
            </button>
        </div>
        
        <p style="text-align: center; color: #64748b; margin-bottom: 30px;">Or download individual tables:</p>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <button class="button" onclick="downloadTable('fact')">📊 Fact_Orders</button>
            <button class="button" onclick="downloadTable('date')">📅 Dim_Date</button>
            <button class="button" onclick="downloadTable('customer')">👥 Dim_Customer</button>
            <button class="button" onclick="downloadTable('product')">📦 Dim_Product</button>
            <button class="button" onclick="downloadTable('geography')">🌍 Dim_Geography</button>
            <button class="button" onclick="downloadTable('salesrep')">👤 Dim_SalesRep</button>
            <button class="button" onclick="downloadTable('channel')">🛒 Dim_Channel</button>
        </div>
        
        <div id="status"></div>
    </div>

    <div class="card">
        <h2>🚀 Power BI Implementation Guide</h2>
        
        <div class="instructions">
            <h3>📋 Import & Relationship Setup:</h3>
            <ol>
                <li><strong>Import all 7 CSV files</strong> into Power BI Desktop</li>
                <li><strong>Create relationships</strong> in Model view:
                    <ul>
                        <li>Fact_Orders[OrderDate] → Dim_Date[Date]</li>
                        <li>Fact_Orders[CustomerID] → Dim_Customer[CustomerID]</li>
                        <li>Fact_Orders[ProductID] → Dim_Product[ProductID]</li>
                        <li>Fact_Orders[GeographyID] → Dim_Geography[GeographyID]</li>
                        <li>Fact_Orders[SalesRepID] → Dim_SalesRep[SalesRepID]</li>
                        <li>Fact_Orders[ChannelID] → Dim_Channel[ChannelID]</li>
                    </ul>
                </li>
                <li><strong>Mark Dim_Date as date table</strong></li>
                <li><strong>Hide foreign keys</strong> in fact table from report view</li>
            </ol>
        </div>

        <h3>📊 Advanced DAX Measures:</h3>
        <div class="code">
// Time Intelligence
Total Revenue = SUM(Fact_Orders[Revenue])
Revenue PY = CALCULATE([Total Revenue], SAMEPERIODLASTYEAR(Dim_Date[Date]))
Revenue YoY Growth = DIVIDE([Total Revenue] - [Revenue PY], [Revenue PY])
Revenue YTD = TOTALYTD([Total Revenue], Dim_Date[Date])
Rolling 12M Revenue = CALCULATE([Total Revenue], DATESINPERIOD(Dim_Date[Date], LASTDATE(Dim_Date[Date]), -12, MONTH))

// Customer Analytics
Customer Count = DISTINCTCOUNT(Fact_Orders[CustomerID])
New Customers = CALCULATE([Customer Count], FILTER(ALL(Dim_Date), Dim_Date[Date] = MINX(RELATEDTABLE(Fact_Orders), Fact_Orders[OrderDate])))
Customer Retention Rate = DIVIDE([Returning Customers], [Total Customers PY])

// Product Performance
Top Product Category = TOPN(1, SUMMARIZE(Dim_Product, Dim_Product[Category], "Revenue", [Total Revenue]), [Revenue])
Product Mix % = DIVIDE([Total Revenue], CALCULATE([Total Revenue], ALL(Dim_Product[ProductName])))

// Geographic Analysis
Top Region = TOPN(1, SUMMARIZE(Dim_Geography, Dim_Geography[Region], "Revenue", [Total Revenue]), [Revenue])
Regional Growth = CALCULATE([Revenue YoY Growth], ALLEXCEPT(Dim_Geography, Dim_Geography[Region]))
        </div>

        <h3>🎨 Dashboard Recommendations:</h3>
        <ul>
            <li><strong>Executive Overview:</strong> KPI cards, trend charts, top performers</li>
            <li><strong>Geographic Analysis:</strong> Map visuals, regional drilling</li>
            <li><strong>Product Performance:</strong> Category analysis, product mix</li>
            <li><strong>Customer Analytics:</strong> Segmentation, retention, lifetime value</li>
            <li><strong>Sales Performance:</strong> Rep rankings, channel effectiveness</li>
        </ul>
    </div>

    <script>
        // Global data storage
        let starSchemaData = {
            fact: [],
            date: [],
            customer: [],
            product: [],
            geography: [],
            salesrep: [],
            channel: []
        };

        function generateStarSchema() {
            console.log('Generating star schema data...');
            
            // Generate dimensions first
            generateDimensions();
            
            // Generate fact table
            generateFactTable();
            
            updateMetrics();
            console.log('Star schema generation complete!');
        }

        function generateDimensions() {
            // Date Dimension (2020-2024)
            starSchemaData.date = [];
            const startDate = new Date('2020-01-01');
            const endDate = new Date('2024-12-31');
            
            for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                const currentDate = new Date(date);
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                const dayOfWeek = currentDate.getDay();
                
                // Fiscal year (starts Feb 1)
                const fiscalYear = month >= 2 ? year + 1 : year;
                const fiscalMonth = month >= 2 ? month - 1 : month + 11;
                const fiscalQuarter = Math.ceil(fiscalMonth / 3);
                
                starSchemaData.date.push({
                    Date: currentDate.toISOString().substr(0, 10),
                    Year: year,
                    Quarter: Math.ceil(month / 3),
                    Month: month,
                    MonthName: currentDate.toLocaleString('default', { month: 'long' }),
                    FiscalYear: fiscalYear,
                    FiscalQuarter: fiscalQuarter,
                    IsWeekend: dayOfWeek === 0 || dayOfWeek === 6,
                    IsBusinessDay: dayOfWeek !== 0 && dayOfWeek !== 6,
                    DayOfWeek: dayOfWeek + 1,
                    WeekOfYear: getWeekNumber(currentDate)
                });
            }

            // Customer Dimension
            starSchemaData.customer = [];
            const industries = ['Technology', 'Healthcare', 'Financial Services', 'Manufacturing', 'Retail', 'Energy', 'Education', 'Government'];
            const companySize = ['Enterprise', 'Mid-Market', 'SMB'];
            const customerTiers = ['Platinum', 'Gold', 'Silver', 'Bronze'];
            
            for (let i = 1; i <= 500; i++) {
                const industry = industries[Math.floor(Math.random() * industries.length)];
                const size = companySize[Math.floor(Math.random() * companySize.length)];
                const tier = customerTiers[Math.floor(Math.random() * customerTiers.length)];
                
                starSchemaData.customer.push({
                    CustomerID: `CUST-${String(i).padStart(4, '0')}`,
                    CustomerName: `${industry} Corp ${i}`,
                    Industry: industry,
                    CompanySize: size,
                    CustomerTier: tier,
                    Segment: size // Link to segment for compatibility
                });
            }

            // Product Dimension
            starSchemaData.product = [];
            const productHierarchy = {
                'Network Infrastructure': {
                    'Hardware': ['Fiber Optic Systems', 'Routing Equipment', 'Switching Hardware'],
                    'Software': ['Network Management', 'Monitoring Tools', 'Security Software']
                },
                'Cloud Solutions': {
                    'Infrastructure': ['Compute Services', 'Storage Solutions', 'Networking'],
                    'Platform': ['Database Services', 'Analytics Platform', 'Development Tools']
                },
                'Security Platforms': {
                    'Perimeter Security': ['Firewall Solutions', 'VPN Systems', 'Network Security'],
                    'Identity & Access': ['Identity Management', 'Access Control', 'Authentication']
                },
                'Analytics Software': {
                    'Business Intelligence': ['Reporting Tools', 'Dashboard Platform', 'Data Visualization'],
                    'Data Management': ['Data Warehousing', 'ETL Tools', 'Data Quality']
                }
            };

            let productId = 1;
            Object.keys(productHierarchy).forEach(category => {
                Object.keys(productHierarchy[category]).forEach(subCategory => {
                    productHierarchy[category][subCategory].forEach((productLine, index) => {
                        for (let i = 1; i <= 3; i++) {
                            starSchemaData.product.push({
                                ProductID: `PROD-${String(productId).padStart(4, '0')}`,
                                ProductName: `${productLine} v${i}.0`,
                                ProductLine: productLine,
                                SubCategory: subCategory,
                                Category: category,
                                PriceTier: ['Standard', 'Professional', 'Enterprise'][i-1]
                            });
                            productId++;
                        }
                    });
                });
            });

            // Geography Dimension
            starSchemaData.geography = [];
            const geoHierarchy = {
                'North America': {
                    'United States': ['New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix'],
                    'Canada': ['Toronto', 'Vancouver', 'Montreal', 'Calgary', 'Ottawa']
                },
                'Europe': {
                    'United Kingdom': ['London', 'Manchester', 'Birmingham', 'Glasgow', 'Liverpool'],
                    'Germany': ['Berlin', 'Munich', 'Hamburg', 'Cologne', 'Frankfurt'],
                    'France': ['Paris', 'Marseille', 'Lyon', 'Toulouse', 'Nice']
                },
                'Asia Pacific': {
                    'Japan': ['Tokyo', 'Osaka', 'Nagoya', 'Sapporo', 'Kobe'],
                    'Australia': ['Sydney', 'Melbourne', 'Brisbane', 'Perth', 'Adelaide'],
                    'Singapore': ['Singapore City', 'Jurong', 'Tampines', 'Woodlands', 'Sengkang']
                },
                'Latin America': {
                    'Brazil': ['São Paulo', 'Rio de Janeiro', 'Brasília', 'Salvador', 'Fortaleza'],
                    'Mexico': ['Mexico City', 'Guadalajara', 'Monterrey', 'Puebla', 'Tijuana']
                }
            };

            let geoId = 1;
            Object.keys(geoHierarchy).forEach(region => {
                Object.keys(geoHierarchy[region]).forEach(country => {
                    geoHierarchy[region][country].forEach(city => {
                        starSchemaData.geography.push({
                            GeographyID: `GEO-${String(geoId).padStart(4, '0')}`,
                            City: city,
                            Country: country,
                            Region: region,
                            SubRegion: country,
                            MarketType: ['Developed', 'Emerging'][Math.floor(Math.random() * 2)]
                        });
                        geoId++;
                    });
                });
            });

            // Sales Rep Dimension
            starSchemaData.salesrep = [];
            const repNames = ['John Smith', 'Sarah Johnson', 'Michael Brown', 'Emily Davis', 'David Wilson', 'Lisa Anderson', 'Robert Taylor', 'Jennifer Martinez', 'William Garcia', 'Amanda Rodriguez'];
            const teams = ['Enterprise Sales', 'Mid-Market Sales', 'SMB Sales', 'Channel Sales'];
            const levels = ['Senior', 'Principal', 'Director', 'VP'];
            
            for (let i = 1; i <= 50; i++) {
                const name = repNames[Math.floor(Math.random() * repNames.length)] + ` ${i}`;
                const team = teams[Math.floor(Math.random() * teams.length)];
                const level = levels[Math.floor(Math.random() * levels.length)];
                const region = ['North America', 'Europe', 'Asia Pacific', 'Latin America'][Math.floor(Math.random() * 4)];
                
                starSchemaData.salesrep.push({
                    SalesRepID: `REP-${String(i).padStart(3, '0')}`,
                    RepName: name,
                    RepTeam: team,
                    RepLevel: level,
                    RepRegion: region,
                    HireDate: new Date(2015 + Math.floor(Math.random() * 8), Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toISOString().substr(0, 10)
                });
            }

            // Channel Dimension
            starSchemaData.channel = [
                { ChannelID: 'CHN-001', ChannelName: 'Direct Sales', ChannelType: 'Direct', CommissionRate: 0.05, CostPercent: 0.15 },
                { ChannelID: 'CHN-002', ChannelName: 'Partner Channel', ChannelType: 'Indirect', CommissionRate: 0.12, CostPercent: 0.22 },
                { ChannelID: 'CHN-003', ChannelName: 'Online Store', ChannelType: 'Digital', CommissionRate: 0.03, CostPercent: 0.08 },
                { ChannelID: 'CHN-004', ChannelName: 'Reseller Network', ChannelType: 'Indirect', CommissionRate: 0.15, CostPercent: 0.25 },
                { ChannelID: 'CHN-005', ChannelName: 'System Integrator', ChannelType: 'Indirect', CommissionRate: 0.18, CostPercent: 0.28 }
            ];
        }

        function generateFactTable() {
            starSchemaData.fact = [];
            let orderId = 1;

            // Generate orders for 2020-2024
            for (let year = 2020; year <= 2024; year++) {
                for (let month = 1; month <= 12; month++) {
                    // Number of orders per month increases over time
                    const baseOrdersPerMonth = 800 + (year - 2020) * 100;
                    const seasonalMultiplier = month >= 11 ? 1.3 : (month <= 2 ? 0.8 : 1.0);
                    const ordersThisMonth = Math.floor(baseOrdersPerMonth * seasonalMultiplier * (0.8 + Math.random() * 0.4));

                    for (let i = 0; i < ordersThisMonth; i++) {
                        // Random selections from dimensions
                        const customer = starSchemaData.customer[Math.floor(Math.random() * starSchemaData.customer.length)];
                        const product = starSchemaData.product[Math.floor(Math.random() * starSchemaData.product.length)];
                        const geography = starSchemaData.geography[Math.floor(Math.random() * starSchemaData.geography.length)];
                        const salesRep = starSchemaData.salesrep[Math.floor(Math.random() * starSchemaData.salesrep.length)];
                        const channel = starSchemaData.channel[Math.floor(Math.random() * starSchemaData.channel.length)];

                        // Generate order date within the month
                        const orderDate = new Date(year, month - 1, Math.floor(Math.random() * 28) + 1);

                        // Calculate revenue based on multiple factors
                        const baseRevenue = {
                            'Network Infrastructure': 120000,
                            'Cloud Solutions': 65000,
                            'Security Platforms': 95000,
                            'Analytics Software': 45000
                        }[product.Category];

                        const sizeMultiplier = {
                            'Enterprise': 2.5,
                            'Mid-Market': 1.0,
                            'SMB': 0.4
                        }[customer.CompanySize];

                        const regionMultiplier = {
                            'North America': 1.3,
                            'Europe': 1.0,
                            'Asia Pacific': 1.1,
                            'Latin America': 0.8
                        }[geography.Region];

                        // Year-over-year growth
                        const yearMultiplier = 1 + ((year - 2020) * 0.08); // 8% annual growth

                        const quantity = Math.floor(Math.random() * 10) + 1;
                        const unitPrice = Math.round(baseRevenue * sizeMultiplier * regionMultiplier * yearMultiplier * (0.8 + Math.random() * 0.4) / quantity);
                        const revenue = unitPrice * quantity;

                        // Calculate costs
                        const baseCostPercent = {
                            'Network Infrastructure': 0.35,
                            'Cloud Solutions': 0.28,
                            'Security Platforms': 0.32,
                            'Analytics Software': 0.25
                        }[product.Category];

                        const cost = Math.round(revenue * (baseCostPercent + channel.CostPercent) * (0.9 + Math.random() * 0.2));
                        const grossProfit = revenue - cost;
                        const marginPercent = Math.round((grossProfit / revenue) * 10000) / 100;

                        starSchemaData.fact.push({
                            OrderID: `ORD-${String(orderId).padStart(7, '0')}`,
                            OrderDate: orderDate.toISOString().substr(0, 10),
                            CustomerID: customer.CustomerID,
                            ProductID: product.ProductID,
                            GeographyID: geography.GeographyID,
                            SalesRepID: salesRep.SalesRepID,
                            ChannelID: channel.ChannelID,
                            Quantity: quantity,
                            UnitPrice: unitPrice,
                            Revenue: revenue,
                            Cost: cost,
                            GrossProfit: grossProfit,
                            GrossMarginPercent: marginPercent
                        });

                        orderId++;
                    }
                }
            }
        }

        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        function updateMetrics() {
            if (starSchemaData.fact.length === 0) return;
            
            const totalRevenue = starSchemaData.fact.reduce((sum, row) => sum + row.Revenue, 0);
            
            document.getElementById('factRecords').textContent = starSchemaData.fact.length.toLocaleString();
            document.getElementById('totalRevenue').textContent = ' + (totalRevenue / 1000000).toFixed(1) + 'M';
        }

        function arrayToCsv(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => {
                    const value = row[header];
                    if (typeof value === 'string' && value.includes(',')) {
                        return `"${value}"`;
                    }
                    return value;
                }).join(','))
            ].join('\n');
            
            return csvContent;
        }

        function downloadCsv(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                return true;
            }
            return false;
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 8000);
            }
        }

        function downloadTable(tableType) {
            if (starSchemaData[tableType].length === 0) {
                generateStarSchema();
            }

            const tableNames = {
                'fact': 'Fact_Orders.csv',
                'date': 'Dim_Date.csv',
                'customer': 'Dim_Customer.csv',
                'product': 'Dim_Product.csv',
                'geography': 'Dim_Geography.csv',
                'salesrep': 'Dim_SalesRep.csv',
                'channel': 'Dim_Channel.csv'
            };

            const data = starSchemaData[tableType];
            const csv = arrayToCsv(data);
            const filename = tableNames[tableType];
            const success = downloadCsv(csv, filename);

            if (success) {
                showStatus(`✅ Downloaded ${filename} (${data.length.toLocaleString()} records)`, 'success');
            } else {
                showStatus(`❌ Failed to download ${filename}`, 'error');
            }
        }

        function downloadAllTables() {
            showStatus('🔄 Generating complete star schema dataset...', 'info');
            
            try {
                generateStarSchema();
                
                const tables = [
                    { key: 'fact', name: 'Fact_Orders.csv' },
                    { key: 'date', name: 'Dim_Date.csv' },
                    { key: 'customer', name: 'Dim_Customer.csv' },
                    { key: 'product', name: 'Dim_Product.csv' },
                    { key: 'geography', name: 'Dim_Geography.csv' },
                    { key: 'salesrep', name: 'Dim_SalesRep.csv' },
                    { key: 'channel', name: 'Dim_Channel.csv' }
                ];

                let downloadCount = 0;
                let totalRecords = 0;

                tables.forEach((table, index) => {
                    setTimeout(() => {
                        const data = starSchemaData[table.key];
                        const csv = arrayToCsv(data);
                        const success = downloadCsv(csv, table.name);
                        
                        if (success) {
                            downloadCount++;
                            totalRecords += data.length;
                        }
                        
                        // Check if all downloads are complete
                        if (index === tables.length - 1) {
                            setTimeout(() => {
                                if (downloadCount === tables.length) {
                                    showStatus(`🎉 Successfully downloaded all ${downloadCount} files! Total records: ${totalRecords.toLocaleString()}`, 'success');
                                } else {
                                    showStatus(`⚠️ Downloaded ${downloadCount} of ${tables.length} files. Some downloads may have failed.`, 'info');
                                }
                            }, 500);
                        }
                    }, index * 500); // Stagger downloads by 500ms
                });
                
            } catch (error) {
                showStatus('❌ Error generating star schema: ' + error.message, 'error');
            }
        }

        // Initialize with sample data generation
        document.addEventListener('DOMContentLoaded', function() {
            generateStarSchema();
        });
    </script>
</body>
</html>
